@page "/home"
@layout MainLayout
@using Blazorise.Charts

<ErrorBoundary>
    <ChildContent>
        <div class="performance-page px-4 py-3">

            <!-- Filters Section -->
            <div class="filters d-flex mb-4 align-items-end">
                <!-- Left side filters: Filter + By -->
                <div class="filter-left d-flex gap-3">
                    <div>
                        <div class="mb-2">Filter:</div>
                        <Select TValue="string" SelectedValue="@SelectedFilter" SelectedValueChanged="@((value) => SelectedFilter = value)" class="me-3">
                            <SelectItem TValue="string" Value="@("Students")">Students</SelectItem>
                            <SelectItem TValue="string" Value="@("Class")">Class</SelectItem>
                        </Select>
                    </div>

                    <div>
                        <div class="mb-2">By:</div>
                        <Select TValue="string" SelectedValue="@SelectedBy" SelectedValueChanged="@((value) => SelectedBy = value)">
                            <SelectItem TValue="string" Value="@("Class")">Class</SelectItem>
                            <SelectItem TValue="string" Value="@("Tests")">Tests</SelectItem>
                            <SelectItem TValue="string" Value="@("Subject")">Subject</SelectItem>
                        </Select>
                    </div>
                </div>

                <!-- Right side filter: Timeframe -->
                <div class="filter-right ms-auto">
                    <div class="mb-2">Timeframe:</div>
                    <Select TValue="string" @bind-SelectedValue="SelectedTimeframe">
                        <SelectItem TValue="string" Value="@("Per Term")">Per Term</SelectItem>
                        <SelectItem TValue="string" Value="@("Per Test")">Per Test</SelectItem>
                        <SelectItem TValue="string" Value="@("Per Year")">Per Year</SelectItem>
                    </Select>
                </div>
            </div>

            <!-- Main Content: Table and Charts -->
            <div class="d-flex">

                <div class="student-table me-5 flex-shrink-0" style="width: 50%; max-height: 45rem; overflow-y: auto;">
                    <table class="table table-striped mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 50px; text-align:center;">
                                    <div class="d-inline-flex align-items-center justify-content-center w-100">
                                        <Dropdown>
                                            <DropdownToggle Outline ShowCaret="false" class="p-0 border-0 bg-transparent">
                                                #
                                            </DropdownToggle>
                                            <DropdownMenu>
                                                <DropdownItem Active="@((SelectedSort == "SurnameAsc"))" @onclick="@(() => SelectedSort = "SurnameAsc")">
                                                    Surname Ascending
                                                </DropdownItem>
                                                <DropdownItem Active="@((SelectedSort == "SurnameDesc"))" @onclick="@(() => SelectedSort = "SurnameDesc")">
                                                    Surname Descending
                                                </DropdownItem>
                                                <DropdownItem Active="@((SelectedSort == "MarkAsc"))" @onclick="@(() => SelectedSort = "MarkAsc")">
                                                    Mark Lowest to Highest
                                                </DropdownItem>
                                                <DropdownItem Active="@((SelectedSort == "MarkDesc"))" @onclick="@(() => SelectedSort = "MarkDesc")">
                                                    Mark Highest to Lowest
                                                </DropdownItem>
                                            </DropdownMenu>
                                        </Dropdown>
                                    </div>
                                </th>
                                <th>Name</th>
                                <th style="width: 80px; text-align:center;">Mark</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var student in Students)
                            {
                                <tr>
                                    <td style="text-align:center;">@student.Id</td>
                                    <td>@student.Name</td>
                                    <td style="text-align:center;">@student.Mark</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>


                <!-- Right: Charts -->
                <div class="charts flex-grow-1">
                    <h5 class="mb-2">Marks per student</h5>
                    <div class="mb-5">
                        <!-- increased from mb-4 to mb-5 for more gap -->
                        <BarChart TItem="double" @ref="histogramChart" />
                    </div>

                    <div class="mt-7">
                        <!-- add top margin to separate from previous chart -->
                        <h5 class="mb-3">Grade by subject (Average of subj.)</h5>
                        @foreach (var subj in Subjects)
                        {
                            <div class="mb-2">
                                <!-- increase from mb-3 to mb-4 for more gap between subjects -->
                                <div class="d-flex justify-content-between">
                                    <span>@subj.Name</span>
                                    <span>@subj.Average</span>
                                </div>
                                <Progress>
                                    <ProgressBar Value="@((int)subj.Average)" Max="30">
                                        @subj.Average%
                                    </ProgressBar>
                                </Progress>
                            </div>
                        }
                    </div>
                </div>


            </div>


        </div>
    </ChildContent>
    <ErrorContent Context="ex">
        <div class="alert alert-danger m-3">
            <h4>Error occurred:</h4>
            <p>@ex.Message</p>
            <details>
                <summary>Stack Trace</summary>
                <pre>@ex.StackTrace</pre>
            </details>
        </div>
    </ErrorContent>
</ErrorBoundary>

@code {
    private string SelectedFilter = "Students";
    private string SelectedBy = "Class";
    private string SelectedTimeframe { get; set; } = "Per Term";
    private string SelectedSort = "SurnameAsc";

    private BarChart<double> histogramChart;

    private List<Student> Students = new()
    {
        new Student { Id = 1, Name = "Alice Smith", Mark = 87 },
        new Student { Id = 2, Name = "Bob Johnson", Mark = 92 },
        new Student { Id = 3, Name = "Charlie Brown", Mark = 75 },
        new Student { Id = 4, Name = "Diana Clark", Mark = 80 },
        new Student { Id = 5, Name = "Ethan Lewis", Mark = 63 },
        new Student { Id = 6, Name = "Fiona Adams", Mark = 55 },
        new Student { Id = 7, Name = "George Hall", Mark = 47 },
        new Student { Id = 8, Name = "Hannah Scott", Mark = 98 },
        new Student { Id = 9, Name = "Ian Walker", Mark = 72 },
        new Student { Id = 10, Name = "Julia King", Mark = 100 },
        new Student { Id = 11, Name = "Kevin Wright", Mark = 81 },
        new Student { Id = 12, Name = "Laura Green", Mark = 69 },
        new Student { Id = 13, Name = "Michael Baker", Mark = 34 },
        new Student { Id = 14, Name = "Nina Campbell", Mark = 90 },
        new Student { Id = 15, Name = "Oliver Young", Mark = 77 },
        new Student { Id = 16, Name = "Paula Edwards", Mark = 88 },
        new Student { Id = 17, Name = "Quentin Hughes", Mark = 59 },
        new Student { Id = 18, Name = "Rachel Price", Mark = 95 },
        new Student { Id = 19, Name = "Samuel Perry", Mark = 66 },
        new Student { Id = 20, Name = "Tina Foster", Mark = 73 }
    };



    private List<SubjectAverage> Subjects = new()
    {
        new SubjectAverage { Name = "Maths", Average = 23 },
        new SubjectAverage { Name = "English", Average = 19 },
        new SubjectAverage { Name = "Art", Average = 27 },
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await SetupHistogram();
        }
    }

    private async Task SetupHistogram()
    {
        if (histogramChart == null)
        {
            Console.WriteLine("Chart is null, skipping setup");
            return;
        }

        try
        {
            var data = Students.Select(s => (double)s.Mark).ToList();
            var labels = Students.Select(s => s.Name).ToArray();

            await histogramChart.Clear();
            await histogramChart.AddLabelsDatasetsAndUpdate(
                labels,
                new BarChartDataset<double>
                {
                    Label = "Marks",
                    BackgroundColor = labels.Select((_, i) =>
                        new[] { "#4da6ff", "#925cf0", "#F803FE", "#925cf0" }[i % 4]
                    ).ToArray(),
                    Data = data
                }
            );
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error setting up histogram: {ex.Message}");
        }
    }


    class Student
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public int Mark { get; set; }
    }

    class SubjectAverage
    {
        public string Name { get; set; }
        public double Average { get; set; }
    }
}
