@page "/home"
@layout MainLayout
@inherits HomeBase
@using MudBlazor

<ErrorBoundary>
    <ChildContent>
        <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="py-4">

            <!-- Filters Section -->
            <MudGrid Class="mb-4">
                <MudItem xs="12" md="6">
                    <MudGrid>
                        <MudItem xs="6" md="4">
                            <MudText Typo="Typo.body2" Class="mb-2">Filter:</MudText>
                            <MudSelect T="string" @bind-Value="SelectedFilter" Variant="Variant.Outlined" Dense="true">
                                <MudSelectItem Value=@("Students")>Students</MudSelectItem>
                                <MudSelectItem Value=@("Class")>Class</MudSelectItem>
                            </MudSelect>
                        </MudItem>

                        <MudItem xs="6" md="4">
                            <MudText Typo="Typo.body2" Class="mb-2">By:</MudText>
                            <MudSelect T="string" @bind-Value="SelectedBy" Variant="Variant.Outlined" Dense="true">
                                <MudSelectItem Value=@("Class")>Class</MudSelectItem>
                                <MudSelectItem Value=@("Tests")>Tests</MudSelectItem>
                                <MudSelectItem Value=@("Subject")>Subject</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                    </MudGrid>
                </MudItem>

                <MudItem xs="12" md="6" Class="d-flex justify-end">
                    <div style="max-width: 250px; width: 100%;">
                        <MudText Typo="Typo.body2" Class="mb-2">Timeframe:</MudText>
                        <MudSelect T="string" @bind-Value="SelectedTimeframe" Variant="Variant.Outlined" Dense="true">
                            <MudSelectItem Value=@("Per Term")>Per Term</MudSelectItem>
                            <MudSelectItem Value=@("Per Test")>Per Test</MudSelectItem>
                            <MudSelectItem Value=@("Per Year")>Per Year</MudSelectItem>
                        </MudSelect>
                    </div>
                </MudItem>
            </MudGrid>

            <!-- Main Content: Table and Charts -->
            <MudGrid>
                <MudItem xs="12" lg="6">
                    <MudPaper Elevation="2" Class="pa-4" Style="max-height: 45rem; overflow-y: auto;">
                        <MudTable Items="@Students" Dense="true" Hover="true" Striped="true">
                            <HeaderContent>
                                <MudTh Style="width: 50px; text-align:center;">
                                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" Dense="true" Size="MudBlazor.Size.Small">
                                        <MudMenuItem OnClick="@(() => SelectedSort = "SurnameAsc")">
                                            <MudText Typo="Typo.body2">Surname Ascending</MudText>
                                        </MudMenuItem>
                                        <MudMenuItem OnClick="@(() => SelectedSort = "SurnameDesc")">
                                            <MudText Typo="Typo.body2">Surname Descending</MudText>
                                        </MudMenuItem>
                                        <MudMenuItem OnClick="@(() => SelectedSort = "MarkAsc")">
                                            <MudText Typo="Typo.body2">Mark Lowest to Highest</MudText>
                                        </MudMenuItem>
                                        <MudMenuItem OnClick="@(() => SelectedSort = "MarkDesc")">
                                            <MudText Typo="Typo.body2">Mark Highest to Lowest</MudText>
                                        </MudMenuItem>
                                    </MudMenu>
                                </MudTh>
                                <MudTh>Name</MudTh>
                                <MudTh Style="width: 70px; text-align:center;">Mark</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd Style="text-align:center;">@context.Id</MudTd>
                                <MudTd>@context.Name</MudTd>
                                <MudTd Style="text-align:center;">@context.Mark</MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" lg="6">
                    <MudPaper Elevation="2" Class="pa-4">
                        <MudText Typo="Typo.h6" Class="mb-3">Marks per student</MudText>
                        <MudChart ChartType="ChartType.Bar"
                                  ChartSeries="@chartSeries"
                                  XAxisLabels="@chartLabels"
                                  ChartOptions="@chartOptions"
                                  AxisChartOptions="@axisOptions"
                                  Width="100%"
                                  Height="400px" />

                        <MudText Typo="Typo.h6" Class="mt-6 mb-3">Grade by subject (Average of subj.)</MudText>
                        @foreach (var subj in subjects)
                        {
                            <div class="mb-4">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mb-1">
                                    <MudText Typo="Typo.body2">@subj.Name</MudText>
                                    <MudText Typo="Typo.body2">@subj.Average%</MudText>
                                </MudStack>
                                <MudProgressLinear Color="MudBlazor.Color.Info"
                                                   Value="@subj.Average"
                                                   Max="100"
                                                   Size="MudBlazor.Size.Medium"
                                                   Class="rounded" />
                            </div>
                        }
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudContainer>
    </ChildContent>
    <ErrorContent Context="ex">
        <MudAlert Severity="Severity.Error" Class="ma-4">
            <MudText Typo="Typo.h6">Error occurred:</MudText>
            <MudText Typo="Typo.body2" Class="mt-2">@ex.Message</MudText>
            <MudExpansionPanels Class="mt-2">
                <MudExpansionPanel Text="Stack Trace">
                    <pre>@ex.StackTrace</pre>
                </MudExpansionPanel>
            </MudExpansionPanels>
        </MudAlert>
    </ErrorContent>
</ErrorBoundary>
